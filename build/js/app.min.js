function isInt(a){return a%1===0}function charCodeFromCharacter(a){return a.charCodeAt(0)}function b64toBlob(a,b,c){b=b||"",c=c||1024;for(var d=atob(a),e=[],f=0;f<d.length;f+=c){var g=d.slice(f,f+c),h=Array.prototype.map.call(g,charCodeFromCharacter),i=new Uint8Array(h);e.push(i)}return new Blob(e,{type:b})}function DoubleLinkedList(){this.length=0,this.first=null,this.last=null}function hide_all_colorpickers(){isMouseClickedInside?isMouseClickedInside=!1:GLOBAL_COLORPICKER_EVENT_BUS.trigger("hide")}function upload_file(a){a.stopPropagation(),a.preventDefault(),$("#file-uploader").click()}function handle_image(a){var b=new FileReader;b.onload=function(b){var c=new Image,d=b.target.result;if(d){var e=d.split("/")[1];e?(e=e.split(";")[0],!e||"jpeg"!=e&&"bmp"!=e&&"png"!=e?APP.alert("Only .png, .jpeg and .bmp supported!"):(c.src=b.target.result,c.onload=function(){APP.Samples.add({type:"img",img:c,layer:APP.Samples.length})})):APP.alert("Only .png, .jpeg and .bmp supported!")}else APP.alert("File is empty!");$(a.target).val("")},b.readAsDataURL(a.target.files[0]),ga("send","event","select_from_pc","select")}function update_dropdown_caption(a){$(a.target).parent().parent().parent().find("a h4").html($(a.target).text()+" <b class='caret'></b>")}function select_from_library(a){a.stopPropagation(),a.preventDefault(),APP.loading(!0);var b="",c=$(this).attr("data-sprite");c?(b=c.split("."),b=_.first(b)+"_"+$(this).attr("data-number")+"."+_.last(b)):(b=$(this).find("img").attr("src"),b=b.split("/"),b=_.last(b)),console.log(b),$.ajax({url:"img/calculated/"+b+".json",success:function(a){"string"==typeof a&&(a=JSON.parse(a));var b=new Image;b.src=a.prefix+a.image,b.onload=function(){APP.Samples.add({type:"img",img:b,layer:APP.Samples.length}),APP.loading(!1)}},error:function(){console.log("error!"),console.log(arguments),APP.loading(!1),APP.alert()}}),$("#collections_modal").modal("hide")}function select_from_internet(a){a.stopPropagation(),a.preventDefault(),APP.loading(!0);var b=$(a.currentTarget).val();ga("send","event","select_from_internet","select",b),$.ajax({type:"post",url:"/imgtob64?img_url="+b,success:function(b){if(null!=b.err)return $(a.currentTarget).addClass("text-danger"),console.log("error!"),console.log(arguments),APP.loading(!1),void APP.alert("Error parsing image!");$(a.currentTarget).removeClass("text-danger");var c=new Image;c.src=b.prefix+b.image,c.onload=function(){APP.Samples.add({type:"img",img:c,layer:APP.Samples.length}),APP.loading(!1)}},error:function(){$(a.currentTarget).addClass("text-danger"),console.log("error!"),console.log(arguments),APP.loading(!1),APP.alert()}}),$("#paste_link_modal").modal("hide")}function on_modal_paste_link_hide(a){$(a.target).find("input").val("").removeClass("text-danger")}function hide_controls_and_show_bg(){APP.Canvas.render_to_bg(),$(".canvas-container").addClass("preview"),$(".controls-section").addClass("flow-down"),ga("send","event","preview-button","click")}function show_controls(){$(".canvas-container").removeClass("preview"),$(".controls-section").removeClass("flow-down")}function add_drawing_mode_sample(){}function recalculate_tab_width(a){var b=$(".sample-tabs"),c=$(window).width()-$(".add-new-sample").width(),d=b.find("> li"),e=d.length;d.each(function(){a?$(this).css("max-width",c/(e-1)+"px"):$(this).css("max-width",c/e+"px")})}function dropdown_add_align(){var a=$(".add-new-sample"),b=a.find(".dropdown-menu"),c=$(window).width()-a.position().left+a.width()+30;c<=b.width()?b.addClass("sticky"):b.removeClass("sticky")}var ANIM_TIME=200;this.templates=this.templates||{},this.templates.library_item=function(a){var b=[],c=a||{};return function(a,c,d,e,f,g){b.push('<a href="#"'+jade.attr("data-number",a,!0,!1)+jade.attr("data-sprite",c,!0,!1)+' class="innerContent"><img src="img/t.gif"'+jade.attr("style","background-image:url('"+d+"'); background-position: "+e+" "+f+"; background-size: "+g+";",!0,!1)+"/></a>")}.call(this,"number"in c?c.number:"undefined"!=typeof number?number:void 0,"sprite_name"in c?c.sprite_name:"undefined"!=typeof sprite_name?sprite_name:void 0,"bg_url"in c?c.bg_url:"undefined"!=typeof bg_url?bg_url:void 0,"offset_x"in c?c.offset_x:"undefined"!=typeof offset_x?offset_x:void 0,"offset_y"in c?c.offset_y:"undefined"!=typeof offset_y?offset_y:void 0,"bg_size"in c?c.bg_size:"undefined"!=typeof bg_size?bg_size:void 0),b.join("")},this.templates.part_settings_tab_header=function(a){var b=[],c=a||{};return function(a,c){b.push("<li><a"+jade.attr("href","#settings-panel-"+a,!0,!1)+' data-toggle="tab"><div><img'+jade.attr("src",c?c.src:"",!0,!1)+'/><button type="button" aria-hidden="true" class="close">Ã—</button></div></a></li>')}.call(this,"id"in c?c.id:"undefined"!=typeof id?id:void 0,"img"in c?c.img:"undefined"!=typeof img?img:void 0),b.join("")},this.templates.part_settings=function(a){var b,c=[],d={},e=a||{};return function(a,e){d.control=function(a,d,e){this&&this.block,this&&this.attributes||{};c.push("<div"+jade.cls(["control",a],[null,!0])+'><label for="part-opacity">'+jade.escape(null==(b=d)?"":b)+"</label><div><div"+jade.attr("data-option",a,!0,!1)+' class="slider"></div></div><input'+jade.attr("id","part-"+a,!0,!1)+jade.attr("tabindex",e,!0,!1)+jade.attr("data-option",a,!0,!1)+' class="input-sm"/></div>')},d["layout-radio"]=function(a,b){this&&this.block,this&&this.attributes||{};c.push("<input"+jade.attr("id",b+"-"+a,!0,!1)+' type="radio"'+jade.attr("name","placement-of-obj-"+a,!0,!1)+jade.attr("value",b,!0,!1)+' class="placement-of-obj"/><label'+jade.attr("for",b+"-"+a,!0,!1)+"><span></span><span"+jade.cls(["type-"+b],[!0])+"></span></label>")},d["grid-radio"]=function(a,d){this&&this.block,this&&this.attributes||{};c.push("<input"+jade.attr("id","grid-"+d+"-"+a,!0,!1)+' type="radio"'+jade.attr("name","grid-of-obj-"+a,!0,!1)+jade.attr("value",d,!0,!1)+' class="grid-of-obj"/><label'+jade.attr("for","grid-"+d+"-"+a,!0,!1)+"><span></span><!--TODO:AUTOFORMAT-->"+jade.escape(null==(b=d)?"":b)+"</label>")},c.push('<h3 class="col-sm-12">'+jade.escape(null==(b=a.index.sample.title)?"":b)+'<button type="button" class="random green-button"><i class="glyphicon glyphicon-refresh"></i>'+jade.escape(null==(b=a.index.sample.all_random)?"":b)+'</button></h3><div class="col-sm-12"><div class="control placement"><label>'+jade.escape(null==(b=a.index.sample.type)?"":b)+'</label><div class="radio-case">'),d["layout-radio"](e,a.index.sample.types.one),d["layout-radio"](e,a.index.sample.types.random),d["layout-radio"](e,a.index.sample.types.circle),c.push('</div></div></div><div class="col-sm-12 col-lg-6">'),d.control("opacity","Opacity",1),d.control("width","Width",2),c.push('<span class="lock-origin-ratio glyphicon glyphicon-lock"></span>'),d.control("height","Height",3),c.push('<div class="control grid"><label>Grid</label><div class="radio-case">'),d["grid-radio"](e,1),d["grid-radio"](e,4),d["grid-radio"](e,9),d["grid-radio"](e,16),d["grid-radio"](e,25),c.push("</div></div>"),d.control("angle","Angle",4),c.push('<div class="control overlay"><label for="picker">Overlay</label><div class="color-picker"></div></div></div><div class="col-sm-12 col-lg-6">'),d.control("count","Count",5),d.control("x","X",6),d.control("y","Y",7),d.control("radius","Radius",8),d.control("offset","Offset",9),d.control("angle-delta","Angle+",10),c.push("</div>")}.call(this,"$i"in e?e.$i:"undefined"!=typeof $i?$i:void 0,"id"in e?e.id:"undefined"!=typeof id?id:void 0),c.join("")},DoubleLinkedList.prototype={add:function(a,b,c){var d={value:a,x:b,y:c,next:null,prev:null};if(this.length){for(var e=this.first;e&&(e.y<d.y||e.y==d.y&&e.x<d.x);)e=e.next;e?e.prev?(d.prev=e.prev,d.next=e,e.prev.next=d,e.prev=d):(d.next=e,e.prev=d,this.first=d):(e=this.last,e.next=d,d.prev=e,this.last=d)}else this.first=d,this.last=d;this.length++},toArray:function(){for(var a=this.first,b=[];a;)b.push(a.value),a=a.next;return b}};var Slider=Backbone.View.extend({keys:[45,46,48,49,50,51,52,53,54,55,56,57],range:null,initialize:function(a){var b=this.range=this.model.get("range")[a.name];this.name=a.name,this.$el=a.jquery_object,this.$input=this.$el.find("input"),this.$slider=this.$el.find(".slider"),this.$input.val(this.model.get(a.name)),this.$slider.slider({animate:ANIM_TIME,min:b.min,max:b.max,step:b.step,value:this.model.get(a.name),range:"min"}),this.model.on("change:range",this.setNewRange,this),this.model.on("change:"+a.name,this.setNewValue,this),this.model.on("remove",this.remove,this)},events:{"slide .slider":"onslide","input input":"on_input","keydown input":"up_and_down"},setNewValue:function(){var a=this.model.get(this.name);this.$slider.slider("value",a),this.$input.val(a)},setNewRange:function(){this.range=this.model.get("range")[this.name],this.$slider.slider("option","min",this.range.min),this.$slider.slider("option","max",this.range.max)},up_and_down:function(a){var b=a.keyCode;if(38==b||40==b){var c=parseInt(Math.round(1e4*$(a.target).val())),d=this.$slider.slider("option"),e=1e4*d.step,f=c%e;38==b&&(c>0||!f)?c+=e:40==b&&(0>c||!f)&&(c-=e),c-=f,c/=1e4,c=Math.max(c,d.min),c=Math.min(c,d.max),this.$input.val(c),this.$input[0].selectionStart=this.$input.val().length,this.$input[0].selectionEnd=this.$input.val().length,this.$slider.slider("value",c),this.save(c)}},on_input:function(a){console.log(a);var b,c=this.$slider.slider("option"),d=this.$input.val(),e=d.replace(/[^\+\-0-9\.]/g,"").match(/[\+\-]{0,1}[0-9]{0,}[\.]{0,1}[0-9]{0,}/)[0],f=d.length-e.length,g=this.$input[0].selectionStart,h=g==d.length;b=isInt(c.step)?parseInt(e):parseFloat(e),isNaN(b)?this.$input.val(e):b<c.min?(b=c.min,this.$input.val(b)):b>c.max?(b=c.max,this.$input.val(b)):this.$input.val(e),h?(this.$input[0].selectionStart=this.$input.val().length,this.$input[0].selectionEnd=this.$input.val().length):(this.$input[0].selectionStart=g+f,this.$input[0].selectionEnd=g+f),isNaN(b)&&(b=c.min),this.$slider.slider("value",b),this.save(this.$slider.slider("value"))},onslide:function(a,b){this.$input.val(b.value),this.save(b.value)},save:function(a){this.model.off("change:"+this.name,this.setNewValue,this),this.model.set(this.name,a),this.model.on("change:"+this.name,this.setNewValue,this)},remove:function(){this.model.off("change:range",this.setNewRange,this),this.model.off("change:"+this.name,this.setNewValue,this),this.model.off("remove",this.remove,this)}}),Canvas=Backbone.Model.extend({defaults:{color:"#FFFFFF",autoupdate:!1,height:300,width:300,lock_ratio:!0,range:{width:{min:0,step:1,max:400},height:{min:0,step:1,max:400}}},initialize:function(){this.canvas(),APP.$wrp=$("#canvas-wrapper"),APP.$cnv=$(".canvas-container"),APP.$prvbtn=$(".preview-button"),APP.$cntr_sec=$(".controls-section"),$(window).resize(_.debounce(function(){var a,b=APP.$prvbtn.height(),c=APP.$cntr_sec.position().top,d=APP.$cnv.width(),e=APP.$cnv.height(),f=(c-b-e)/2+b,g=$(window).width()/d,h=(c-b)/e,i=Math.min(1,Math.min(g,h));f=1>h?b:Math.max(b,f),a=1>g?($(window).width()-d)/2:"",APP.$wrp.css({"-webkit-transform":"scale("+i+")",transform:"scale("+i+")","margin-left":a,"margin-top":f+"px"});var j=APP.$cnv.offset();$(".pattern-preview-area").css({"background-position":j.left+"px "+j.top+"px","background-size":i*d+"px "+i*e+"px"})},100)).resize(),new CanvasView({model:this}),this.update=_.throttle(this.update,20),this.on("change",this.update),this.on("change:lock_ratio",this.lock_ratio),this.on("change:width",this.width),this.on("change:height",this.height),this.on("change:color",this.color),this.on("change:autoupdate",this.update)},canvas:function(){this.canvas=new fabric.Canvas("canvas"),this.canvas.renderOnAddRemove=!1,this.color(),this.height(),this.width(),this.getWidth=_.bind(this.canvas.getWidth,this.canvas),this.getHeight=_.bind(this.canvas.getHeight,this.canvas),this.getCenter=_.bind(this.canvas.getCenter,this.canvas),this.add=_.bind(this.canvas.add,this.canvas)},color:function(){this.canvas.setBackgroundColor(this.get("color"))},width:function(){this.canvas.setWidth(this.get("width")),$("#canvas-wrapper").width(this.get("width")),this.get("lock_ratio")&&this.get("width")!=this.get("height")&&this.set("height",this.get("width")),$(window).resize()},height:function(){this.canvas.setHeight(this.get("height")),$("#canvas-wrapper").height(this.get("height")),this.get("lock_ratio")&&this.get("width")!=this.get("height")?this.set("width",this.get("height")):$(window).resize()},removeAll:function(){this.canvas._objects=[]},lock_ratio:function(){var a=Math.max(this.get("width"),this.get("height"));this.set({width:a,height:a})},update:function(){this.canvas._objects=_.sortBy(this.canvas._objects,function(a){return a.layer}),this.get("autoupdate")?this.render_to_bg():this.canvas.renderAll(!1)},render_to_bg:function(){$(".pattern-preview-area").css("background-image","url("+this.canvas.toDataURL({format:"png",quality:1})+")")},download_image:function(){var a=this.canvas.toDataURL({format:"png",quality:1}),b=a.split(",")[1],c=b64toBlob(b,"image/png");saveAs(c,"awesome-pattern_"+_.random(1e5,2e5)+".png")}}),CanvasView=Backbone.View.extend({initialize:function(){this.$el=$(".canvas-options"),$(".autofill-checkbox span").tooltip(),this.model.get("lock_ratio")&&this.$el.find(".lock-origin-ratio").addClass("locked"),this.colorpicker=new Colorpicker(null,{el:this.$el.find(".color-picker").eq(0),alpha:!1}),this.colorpicker.set("hex",this.model.get("color")),this.colorpicker.view.update_all(),this.colorpicker.on("change:color",_.bind(this.color_changed,this)),new Slider({model:this.model,name:"width",jquery_object:this.$el.find(".width")}),new Slider({model:this.model,name:"height",jquery_object:this.$el.find(".height")})},events:{"input .colorpicker":"color_changed","change #autofill-checkbox":"autoupdate_changed","click .lock-origin-ratio":"ratio_changed","click .download":"download_image"},ratio_changed:function(){this.$el.find(".lock-origin-ratio").toggleClass("locked"),this.model.set("lock_ratio",!this.model.get("lock_ratio"))},color_changed:function(){this.model.set("color",this.colorpicker.get("hex"))},autoupdate_changed:function(a){this.model.set("autoupdate",$(a.target).prop("checked"))},download_image:function(){this.model.download_image()}}),Colorpicker=Backbone.Model.extend({view:null,defaults:{rgb:{r:0,g:0,b:0},hsv:{h:.5,s:.5,v:.5},hex:"#000000",alpha:.5},initialize:function(a,b){this.set("alpha",b.alpha?0:1),this.view=new ColorpickerView({model:this,el:b.el,alpha:b.alpha}),this.on("change:hsv",this.hsv_changed),this.on("change:rgb",this.rgb_changed),this.on("change:hex",this.hex_changed),this.on("change:alpha",this.alpha_changed)},hsv_changed:function(){var a=this.get("hsv"),b=this.cnv.hsvtorgb(a),c=this.cnv.rgbtohex(b);this.set("rgb",b,{silent:!0}),this.set("hex",c,{silent:!0}),this.trigger("change:color")},rgb_changed:function(){var a=this.get("rgb"),b=this.cnv.rgbtohsv(a),c=this.cnv.rgbtohex(a);this.set("hsv",b,{silent:!0}),this.set("hex",c,{silent:!0}),this.trigger("change:color")},hex_changed:function(){var a=this.get("hex"),b=this.cnv.hextorgb(a),c=this.cnv.rgbtohsv(b);this.set("hsv",c,{silent:!0}),this.set("rgb",b,{silent:!0}),this.trigger("change:color")},alpha_changed:function(){this.trigger("change:color")},setRGBA:function(a){this.attributes.rgb={r:a.r,g:a.g,b:a.b},this.attributes.alpha=a.a,this.rgb_changed(),this.view.update_all()},getRGBA:function(){return $.extend(this.get("rgb"),{a:this.get("alpha")})},getHSVA:function(){return $.extend(this.get("hsv"),{a:this.get("alpha")})},getRGBA_string:function(){var a=this.get("rgb");return"rgba("+a.r+", "+a.g+", "+a.b+", "+this.get("alpha").toFixed(2)+")"},cnv:{hsvtohex:function(a){return this.rgbtohex(this.hsvtorgb(a))},hsvtorgb:function(a){var b,c,d,e,f,g,h,i,j,k,l,m;return e=a.h,j=a.s,l=a.v,f=Math.floor(6*e),c=6*e-f,g=l*(1-j),h=l*(1-c*j),k=l*(1-(1-c)*j),f%=6,m=function(){switch(!1){case 0!==f:return[l,k,g];case 1!==f:return[h,l,g];case 2!==f:return[g,l,k];case 3!==f:return[g,h,l];case 4!==f:return[k,g,l];case 5!==f:return[l,g,h];default:return[1,1,1]}}(),i=m[0],d=m[1],b=m[2],{r:Math.floor(255*i),g:Math.floor(255*d),b:Math.floor(255*b)}},rgbtohsv:function(a){var b,c,d,e,f,g,h,i,j;if(h=a.r,d=a.g,b=a.b,h/=255,d/=255,b/=255,f=Math.max(h,d,b),g=Math.min(h,d,b),j=f,c=f-g,i=0===f?0:c/f,f===g)e=0;else{switch(f){case h:e=(d-b)/c+(b>d?6:0);break;case d:e=(b-h)/c+2;break;case b:e=(h-d)/c+4}e/=6}return{h:e,s:i,v:j}},rgbtohex:function(a){return"#"+this.ntohex(a.r)+this.ntohex(a.g)+this.ntohex(a.b)},ntohex:function(a){return a?(a=Math.max(0,Math.min(a,255)),"0123456789ABCDEF".charAt((a-a%16)/16)+"0123456789ABCDEF".charAt(a%16)):"00"},hextorgb:function(a){var b;return b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a),b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:{r:255,g:255,b:255}}}}),GLOBAL_COLORPICKER_EVENT_BUS=_.extend({},Backbone.Events),isMouseClickedInside=!1,ColorpickerView=Backbone.View.extend({template_color:"<input class='hex-color' type='text' maxlength='7'><div class='picker'><div class='map'><div class='pointer'></div></div><div class='column value'><div class='selector'><div class='arr-l'></div><div class='arr-r'></div></div></div></div>",template_alpha:"<input class='alpha' type='text' maxlength='4'><div class='op-picker'><div class='column alpha'><div class='alpha-gradient'><div class='selector'><div class='arr-l'></div><div class='arr-r'></div></div></div></div></div>",template_result:"<div class='result-wrapper'><div class='color-result'></div></div>",events:{"focus .hex-color":"show_picker","input .hex-color":"parseColor","focus .alpha":"show_op_picker","input .alpha":"parseAlpha","keydown .alpha":"keydown_op_picker","click .color-result":"show_picker","mousedown .map":"pointerStartmove","mousedown .value":"selectorStartmove","mousedown .alpha-gradient":"opselectorStartmove","click .map":"change_mouse_state","click .value":"change_mouse_state","click .alpha-gradient":"change_mouse_state"},initialize:function(a){this.$el.append(this.template_color+this.template_alpha+this.template_result),this.$el.click(_.bind(this.stop_propagation,this)),this._$={},this._$.color_input=this.$el.find("input.hex-color"),this._$.color_picker=this.$el.find("div.picker"),this._$.color_map=this._$.color_picker.find(".map"),this._$.value_col=this._$.color_picker.find(".value"),this._$.alpha_input=this.$el.find("input.alpha"),this._$.alpha_picker=this.$el.find("div.op-picker"),this._$.alpha_col=this._$.alpha_picker.find(".alpha-gradient"),a.alpha||this._$.alpha_input.attr("disabled",!0).css("display","none"),this._$.color_map_pointer=this._$.color_map.find(".pointer"),this._$.color_value_selector=this._$.value_col.find(".selector"),this._$.alpha_col_selector=this._$.alpha_col.find(".selector"),this._$.result=this.$el.find("div.color-result"),this.messages=GLOBAL_COLORPICKER_EVENT_BUS,this.messages.on("hide",_.bind(this.hide_all,this)),this.pointerMove=_.bind(this.pointerMove,this),this.pointerStartmove=_.bind(this.pointerStartmove,this),this.pointerStopmove=_.bind(this.pointerStopmove,this),this.selectorMove=_.bind(this.selectorMove,this),this.selectorStartmove=_.bind(this.selectorStartmove,this),this.selectorStopmove=_.bind(this.selectorStopmove,this),this.opselectorMove=_.bind(this.opselectorMove,this),this.opselectorStartmove=_.bind(this.opselectorStartmove,this),this.opselectorStopmove=_.bind(this.opselectorStopmove,this),this.update_colors(),this.update_controls(),this.update_inputs(),this.model.on("change:hsv",_.bind(this.update_colors,this))},stop_propagation:function(a){a.stopPropagation(),a.preventDefault()},update_all:function(){this.update_colors(),this.update_controls(),this.update_inputs()},update_colors:function(){{var a=this.model.get("hsv"),b=this.model.get("rgb");this.model.get("alpha")}this._$.color_map.css({background:"-webkit-linear-gradient(top, rgba(255, 255, 255, "+(1-a.s)+"), #000000), -webkit-linear-gradient(to right, #ff0000 0%, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000)","background-image":"linear-gradient(to bottom, rgba(255, 255, 255, "+(1-a.s)+"), #000), linear-gradient(to right, #F00 0%, #FF0, #0F0, #0FF, #00F, #F0F, #F00)"}),this._$.value_col.css({"background-color":this.model.cnv.hsvtohex({h:a.h,s:1,v:a.v})}),this._$.alpha_col.css({background:"-webkit-linear-gradient(to bottom, rgba("+b.r+", "+b.g+", "+b.b+", 1), rgba("+b.r+", "+b.g+", "+b.b+", 0))","background-image":"linear-gradient(to bottom, rgba("+b.r+", "+b.g+", "+b.b+", 1), rgba("+b.r+", "+b.g+", "+b.b+", 0))"}),this._$.result.css({"background-color":this.model.getRGBA_string()})},update_controls:function(){var a=this.model.get("hsv"),b=this.model.get("alpha");this._$.color_map_pointer.css({top:100*(1-a.v)+"%",left:100*a.h+"%"}),this._$.color_value_selector.css("top",100*(1-a.s)+"%"),this._$.alpha_col_selector.css("top",100*(1-b)+"%")},update_inputs:function(){var a=this.model.get("hex"),b=this.model.get("alpha");this._$.color_input.val(a),this._$.alpha_input.val(b.toFixed(2))},show_picker:function(a){a.stopPropagation(),a.preventDefault(),this._$.color_picker.height()+this._$.color_input.outerHeight(!0)+this._$.color_input.offset().top<=$(window).height()?this._$.color_picker.css({top:this._$.color_input.outerHeight(!0)+this._$.color_input.position().top+2+"px",left:this._$.color_input.position().left+"px"}).removeClass("upSideDown"):this._$.color_picker.css({top:-3-this._$.color_picker.height()+"px",left:this._$.color_input.position().left+"px"}).addClass("upSideDown"),this.messages.trigger("hide"),this._$.color_picker.addClass("vis").removeClass("none")},hide_picker:function(){this._$.color_picker.addClass("none")},show_op_picker:function(a){a.stopPropagation(),a.preventDefault(),this._$.alpha_picker.height()+this._$.alpha_input.outerHeight(!0)+this._$.alpha_input.offset().top<=$(window).height()?this._$.alpha_picker.css({top:this._$.alpha_input.outerHeight(!0)+this._$.alpha_input.position().top+2+"px",left:this._$.alpha_input.position().left+"px"}).removeClass("upSideDown"):this._$.alpha_picker.css({top:-3-this._$.alpha_picker.height()+"px",left:this._$.alpha_input.position().left+"px"}).addClass("upSideDown"),this.messages.trigger("hide"),this._$.alpha_picker.addClass("vis").removeClass("none")},hide_op_picker:function(){this._$.alpha_picker.addClass("none")},hide_all:function(){this.hide_picker(),this.hide_op_picker()},bind_focus:function(){$("body").addClass("unselectable"),this._$.color_input.blur(),this._$.alpha_input.blur()},unbind_focus:function(){$("body").removeClass("unselectable"),this._$.color_input.blur(),this._$.alpha_input.blur()},pointerStartmove:function(a){$(document).on({mouseover:this.pointerMove,mousemove:this.pointerMove,mouseup:this.pointerStopmove}),this.bind_focus(),this.pointerMove(a),this.show_picker(a),isMouseClickedInside=!0},pointerStopmove:function(){this.unbind_focus(),$(document).off({mouseover:this.pointerMove,mousemove:this.pointerMove,mouseup:this.pointerStopmove})},pointerMove:function(a){a.stopPropagation(),a.preventDefault();var b,c,d,e,f;d=this._$.color_map.offset(),c=this._$.color_map.width(),b=this._$.color_map.height(),e=100*(a.clientX-d.left)/c,f=100*(a.clientY-d.top)/b,e=Math.max(Math.min(100,e),0),f=Math.max(Math.min(100,f),0),this._$.color_map_pointer.css("top",f+"%"),this._$.color_map_pointer.css("left",e+"%"),this.model.attributes.hsv.h=e/100,this.model.attributes.hsv.v=(100-f)/100,this.model.trigger("change:hsv"),this.update_colors(),this.update_inputs()},selectorStartmove:function(a){$(document).on({mouseover:this.selectorMove,mousemove:this.selectorMove,mouseup:this.selectorStopmove}),this.bind_focus(),this.selectorMove(a),this.show_picker(a),isMouseClickedInside=!0},selectorStopmove:function(){this.unbind_focus(),$(document).off({mouseover:this.selectorMove,mousemove:this.selectorMove,mouseup:this.selectorStopmove})},selectorMove:function(a){a.stopPropagation(),a.preventDefault(),y=100*(a.clientY-this._$.value_col.offset().top)/this._$.value_col.height(),y=Math.max(Math.min(100,y),0),this._$.color_value_selector.css("top",y+"%"),this.model.attributes.hsv.s=(100-y)/100,this.model.trigger("change:hsv"),this.update_colors(),this.update_inputs()},opselectorStartmove:function(a){$(document).on({mouseover:this.opselectorMove,mousemove:this.opselectorMove,mouseup:this.opselectorStopmove}),this.bind_focus(),this.opselectorMove(a),this.show_op_picker(a),isMouseClickedInside=!0},opselectorStopmove:function(){this.unbind_focus(),$(document).off({mouseover:this.opselectorMove,mousemove:this.opselectorMove,mouseup:this.opselectorStopmove})},opselectorMove:function(a){a.stopPropagation(),a.preventDefault(),y=100*(a.clientY-this._$.alpha_col.offset().top)/this._$.alpha_col.height(),y=Math.max(Math.min(100,y),0),this._$.alpha_col_selector.css("top",y+"%"),this.model.set("alpha",(100-y)/100),this.update_colors(),this.update_inputs()},parseColor:function(a){this.show_picker(a);var b=[],c=this._$.color_input.val(),d=c.replace(/[^A-Fa-f0-9]/g,"");if(("#"!=c[0]||c.length-1!=d.length)&&(pos=this._$.color_input[0].selectionStart,this._$.color_input.val("#"+d),pos!=c.length&&(this._$.color_input[0].selectionStart=pos-1,this._$.color_input[0].selectionEnd=pos-1)),0==d.length&&(d="FFFFFF"),3==d.length)d=d[0]+d[0]+d[1]+d[1]+d[2]+d[2];else for(;d.length<6;)d+=d[d.length-1];for(;d.length>=2;)b.push(parseInt(d.substring(0,2),16)),d=d.substring(2,d.length);this.model.attributes.rgb={r:b[0],g:b[1],b:b[2]},this.model.trigger("change:rgb"),this.update_controls(),this.update_colors()},parseAlpha:function(a){this.show_op_picker(a);var b,c=this._$.alpha_input.val(),d=c.replace(/[^\+\-0-9\.]/g,"").match(/[\+\-]{0,1}[0-9]{0,}[\.]{0,1}[0-9]{0,}/)[0],e=c.length-d.length,f=this._$.alpha_input[0].selectionStart,g=f==c.length;b=parseFloat(d),isNaN(b)?this._$.alpha_input.val(d):0>b?(b=0,this._$.alpha_input.val(b)):b>1?(b=1,this._$.alpha_input.val(b)):this._$.alpha_input.val(d),g?(this._$.alpha_input[0].selectionStart=this._$.alpha_input.val().length,this._$.alpha_input[0].selectionEnd=this._$.alpha_input.val().length):(this._$.alpha_input[0].selectionStart=f+e,this._$.alpha_input[0].selectionEnd=f+e),isNaN(b)&&(b=0),this.model.set("alpha",b),this.update_colors(),this.update_controls()},keydown_op_picker:function(a){var b=a.keyCode;if(38==b||40==b){var c=parseInt(Math.round(1e4*this._$.alpha_input.val())),d=100,e=c%d;38==b&&(c>0||!e)?c+=d:40==b&&(0>c||!e)&&(c-=d),c-=e,c/=1e4,c=Math.max(c,0),c=Math.min(c,1),this._$.alpha_input.val(c),this._$.alpha_input[0].selectionStart=this._$.alpha_input.val().length,this._$.alpha_input[0].selectionEnd=this._$.alpha_input.val().length,this.model.set("alpha",c),this.update_colors(),this.update_controls()}},change_mouse_state:function(){isMouseClickedInside=!1},removeVisClass:function(){this._$.color_picker.removeClass("vis"),this._$.alpha_picker.removeClass("vis")}});$(document).on("click",hide_all_colorpickers);var SampleView=Backbone.View.extend({$tabHeader:null,tagName:"div",className:"tab-pane fade",template:templates.part_settings,tabHeaderTemplate:templates.part_settings_tab_header,colorpicker:null,j:{x:null,y:null,height:null,width:null,opacity:null,angle:null,count:null,offset:null,radius:null,angle_delta:null,colorpicker:null,origin_ratio:null},init_controls:function(){switch(this.j.x=this.$el.find(".x"),this.j.y=this.$el.find(".y"),this.j.angle=this.$el.find(".angle"),this.j.angle_delta=this.$el.find(".angle-delta"),this.j.width=this.$el.find(".width"),this.j.height=this.$el.find(".height"),this.j.opacity=this.$el.find(".opacity"),this.j.count=this.$el.find(".count"),this.j.offset=this.$el.find(".offset"),this.j.radius=this.$el.find(".radius"),this.j.colorpicker=this.$el.find(".color-picker"),this.j.origin_ratio=this.$el.find(".lock-origin-ratio"),this.$tabHeader.find("button.close").click(_.bind(this.remove,this)),this.$tabHeader.find('a[data-toggle="tab"]').on("show.bs.tab",_.bind(function(){this.colorpicker.view.removeVisClass()},this)),this.bump_opacity=_.once(this.bump_opacity),this.colorpicker=new Colorpicker(null,{el:this.$el.find(".color-picker").eq(0),alpha:!0}),this.colorpicker.setRGBA(this.model.get("overlay")),this.colorpicker.on("change:color",_.bind(this.color_changed,this)),this.$el.find("input.grid-of-obj[value="+this.model.get("grid")+"]").attr("checked",!0),this.$el.find("input.placement-of-obj[value="+this.model.get("placement")+"]").attr("checked",!0),this.model.get("lock_ratio")&&this.j.origin_ratio.addClass("locked"),this.$el.find(".placement input:checked").val()){case"one":this.j.x.show(),this.j.y.show(),this.j.angle.show(),this.j.count.hide(),this.j.offset.hide(),this.j.angle_delta.hide(),this.j.radius.hide();break;case"random":this.j.x.hide(),this.j.y.hide(),this.j.angle.hide(),this.j.count.show(),this.j.offset.hide(),this.j.angle_delta.hide(),this.j.radius.hide();break;case"circle":this.j.x.show(),this.j.y.show(),this.j.angle.show(),this.j.count.show(),this.j.offset.show(),this.j.angle_delta.show(),this.j.radius.show()}return new Slider({model:this.model,name:"angle",jquery_object:this.j.angle}),new Slider({model:this.model,name:"opacity",jquery_object:this.j.opacity}),new Slider({model:this.model,name:"width",jquery_object:this.j.width}),new Slider({model:this.model,name:"height",jquery_object:this.j.height}),new Slider({model:this.model,name:"count",jquery_object:this.j.count}),new Slider({model:this.model,name:"x",jquery_object:this.j.x}),new Slider({model:this.model,name:"y",jquery_object:this.j.y}),new Slider({model:this.model,name:"radius",jquery_object:this.j.radius}),new Slider({model:this.model,name:"angle_delta",jquery_object:this.j.angle_delta}),new Slider({model:this.model,name:"offset",jquery_object:this.j.offset}),this},change_settings_order:function(){switch(this.$el.find(".placement input:checked").val()){case"one":this.j.x.slideDown(ANIM_TIME),this.j.y.slideDown(ANIM_TIME),this.j.angle.slideDown(ANIM_TIME),this.j.count.slideUp(ANIM_TIME),this.j.offset.slideUp(ANIM_TIME),this.j.angle_delta.slideUp(ANIM_TIME),this.j.radius.slideUp(ANIM_TIME);break;case"random":this.j.x.slideUp(ANIM_TIME),this.j.y.slideUp(ANIM_TIME),this.j.angle.slideUp(ANIM_TIME),this.j.count.slideDown(ANIM_TIME),this.j.offset.slideUp(ANIM_TIME),this.j.angle_delta.slideUp(ANIM_TIME),this.j.radius.slideUp(ANIM_TIME);break;case"circle":this.j.x.slideDown(ANIM_TIME),this.j.y.slideDown(ANIM_TIME),this.j.angle.slideDown(ANIM_TIME),this.j.count.slideDown(ANIM_TIME),this.j.offset.slideDown(ANIM_TIME),this.j.angle_delta.slideDown(ANIM_TIME),this.j.radius.slideDown(ANIM_TIME)}},place:function(){return $(".controls-section .tabs-header").append(this.$tabHeader),$(".controls-section .tab-content").append(this.$el),this.$tabHeader.find("a").tab("show"),this.$tabHeader.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){$(this).unbind(),$(this).removeClass("onAdd"),dropdown_add_align()}),this.$tabHeader.addClass("onAdd"),this},render:function(){return this.$el.html(this.template(_.assign({$i:localeStrings},this.model.attributes))),this.$el.attr("id","settings-panel-"+this.model.get("id")),this.$tabHeader=$(this.tabHeaderTemplate(this.model.attributes)),this},events:{"change input[type=radio]":"radio_changed","change input.placement-of-obj":"change_settings_order","changeColor input.colorpicker":"color_changed","click .lock-origin-ratio":"ratio_changed","click button.random":"random"},random:function(){this.$el.find("button.random").attr("disabled",!0),this.model.randomize();var a=this.model.attributes;this.$el.find(".placement input[value="+a.placement+"]").prop("checked",!0),this.$el.find(".grid input[value="+a.grid+"]").prop("checked",!0),this.change_settings_order(),this.colorpicker.setRGBA(a.overlay),this.$el.find("button.random").attr("disabled",!1)},onslide:function(a,b){$(a.target).parent().parent().find("input").val(b.value),this.save($(a.target).attr("data-option"))},save:function(a){var b=this.$el.find("input[data-option="+a+"]").val();""==b&&(b=this.model.default[a]),this.model.set(a,parseFloat(b))},remove:function(a){a.stopPropagation(),a.preventDefault(),APP.Samples.remove(this.model),this.$tabHeader.hasClass("active")&&(this.$tabHeader.find("a").attr("data-toggle",null),$('.sample-tabs a[data-toggle="tab"]:first').tab("show")),this.$tabHeader.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){$(this).remove(),recalculate_tab_width(),dropdown_add_align()
}),this.$tabHeader.addClass("onRemove"),this.$el.remove()},radio_changed:function(a){var b=$(a.target).attr("class").replace("-of-obj","").replace("-","_");"grid"==b?this.model.set(b,parseInt($(a.target).val())):"placement"==b&&this.model.set(b,$(a.target).val())},ratio_changed:function(){this.j.origin_ratio.toggleClass("locked"),this.model.set("lock_ratio",!this.model.get("lock_ratio"))},color_changed:function(){this.model.set("overlay",this.colorpicker.getRGBA()),this.bump_opacity(),this.model.model_changed({changed:{overlay:null}})},bump_opacity:function(){var a=this.colorpicker.getRGBA();a.a=1,this.colorpicker.setRGBA(a)}}),Sample=Backbone.Model.extend({objects:null,original_fabric:null,events:null,defaults:{layer:0,count:5,placement:"one",angle:0,opacity:1,overlay:{r:0,g:0,b:0,a:0},angle_delta:0,offset:0,grid:1,x:0,y:0,radius:40,lock_ratio:!0,ratio:1,range:{angle:{min:-180,step:1,max:180},offset:{min:0,step:1,max:360},opacity:{min:0,step:.01,max:1},width:{min:0,step:1},height:{min:0,step:1},count:{min:1,step:1,max:20},placement:{values:["one","random","circle"]},angle_delta:{min:0,step:1,max:360},grid:{values:[1,4,9,16,25]},x:{step:1},y:{step:1},radius:{min:0,step:1}}},initialize:function(){this.events=_.extend({},Backbone.Events),this.objects=new Backbone.Collection([],{model:Grid}),this.set({id:this.cid}),this.setRange();var a=this.get("range"),b=this.get("img"),c=Math.min(b.width,a.width.max/2),d=Math.min(b.height,a.height.max/2),e=b.width/b.height;this.set({width:Math.min(c,d*e),height:Math.min(d,c/e),ratio:e});for(var f=0;f<a.count.max;f++)this.objects.add({x:this.get("x"),y:this.get("y"),angle:this.get("angle"),grid:this.get("grid"),height:this.get("height"),width:this.get("width"),layer:this.get("layer"),img:this.get("img")},{sample_events:this.events});this.change_layout(),this.layout(),this.events.trigger("change:opacity",this.get("opacity")),this.on("change",this.model_changed),this.on("remove",this.remove),APP.Canvas.on("change:width change:height",this.canvasSizeChanged,this)},resize_and_filter:function(a){var b=this.get("overlay"),c="rgba("+b.r+", "+b.g+", "+b.b+", "+b.a+")";this.original_fabric=new fabric.Image(this.get("img"),{filters:[new fabric.Image.filters.Tint({color:c})]}),this.original_fabric.applyFilters(_.bind(function(){this.events.trigger("change:fabric_element",this.original_fabric._element),a&&a()},this))},model_changed:function(a){var b=a.changed;_.has(b,"placement")&&this.change_layout(),_.has(b,"lock_ratio")&&this.lock_ratio(),this.get("lock_ratio")&&(_.has(b,"width")||_.has(b,"height"))&&this.process_ratio(b),(_.has(b,"placement")||!_.isEmpty(_.omit(b,"opacity","range","filter","overlay")))&&(this.layout(),this.events.trigger("change:grid"),_.has(b,"opacity")||this.events.trigger("change:opacity",this.get("opacity"))),_.has(b,"layer")&&(this.events.trigger("change:layer",b.layer),_.isEmpty(_.omit(b,"layer")))||(_.has(b,"opacity")&&this.events.trigger("change:opacity",b.opacity),_.has(b,"overlay")?this.updateFilter(_.bind(function(){this.events.trigger("change:fabric_element",this.original_fabric._element),this.trigger("render")},this)):this.trigger("render"))},setRange:function(){var a=this.get("range"),b=this.get("lock_ratio"),c=this.get("ratio");b?(a.width.max=Math.min(2*APP.Canvas.getHeight()*c,2*APP.Canvas.getWidth()),a.height.max=Math.min(2*APP.Canvas.getWidth()/c,2*APP.Canvas.getHeight())):(a.width.max=2*APP.Canvas.getWidth(),a.height.max=2*APP.Canvas.getHeight()),a.x.max=Math.round(APP.Canvas.getWidth()/2),a.x.min=-Math.round(APP.Canvas.getWidth()/2),a.y.max=Math.round(APP.Canvas.getHeight()/2),a.y.min=-Math.round(APP.Canvas.getHeight()/2),a.radius.max=Math.min(APP.Canvas.getHeight(),APP.Canvas.getWidth()),this.trigger("change:range",{changed:{range:a}})},updateElementSize:function(){var a=this.get("range"),b=this.get("width"),c=this.get("height");if(this.get("lock_ratio")){var d,e,f=this.get("ratio");e=Math.min(Math.min(b,a.width.max)/f,a.height.max),d=e*f,b=b+1>d&&d>b-1?b:d,c=c+1>e&&e>c-1?c:e}else b=Math.min(b,a.width.max),c=Math.min(c,a.height.max);this.set({width:b,height:c,x:Math.max(Math.min(this.get("x"),a.x.max),a.x.min),y:Math.max(Math.min(this.get("y"),a.y.max),a.y.min),radius:Math.min(this.get("radius"),a.radius.max)})},change_layout:function(){var a;switch(this.layout=this.layouts[this.get("placement")],this.events.trigger("visible",!1),this.get("placement")){case"one":this.objects.at(0).visible(!0);break;case"random":var b=[],c=this.get("range");for(a=0;a<this.objects.length;a++)b[a]={x:_.random(c.x.min,c.x.max),y:_.random(c.y.min,c.y.max),angle:_.random(c.angle.min,c.angle.max)};for(a=0;a<this.objects.length;a++)this.objects.at(a).set(b[a]);break;case"circle":}},layouts:{one:function(){var a=this.get("x"),b=this.get("y"),c=this.get("angle"),d=this.get("grid"),e=this.get("height"),f=this.get("width"),g={x:a,y:b,angle:c,grid:d,height:e,width:f};this.objects.at(0).set(g)},random:function(){var a,b=this.get("count"),c=this.get("grid"),d=this.get("height"),e=this.get("width"),f=[];for(a=0;b>a;a++)f[a]={grid:c,height:d,width:e};for(a=0;a<this.objects.length;a++)this.objects.at(a).set(f[a]).visible(!0);for(a=b;a<this.objects.length;a++)this.objects.at(a).visible(!1)},circle:function(){var a,b=this.get("count"),c=360/b,d=this.get("offset"),e=this.get("radius"),f=this.get("x"),g=this.get("y"),h=this.get("angle"),i=this.get("angle_delta"),j=this.get("grid"),k=this.get("height"),l=this.get("width"),m=[];for(a=0;b>a;a++)m[a]={x:f+e*Math.sin(Math.PI*(d+c*a)/180),y:g+e*Math.cos(Math.PI*(d+c*a)/180),angle:h+i*a,grid:j,height:k,width:l,visible:!0};for(a=0;a<this.objects.length;a++)this.objects.at(a).set(m[a]);for(a=b;a<this.objects.length;a++)this.objects.at(a).set("visible",!1)}},remove:function(){this.events.trigger("remove:fabric"),this.off(null,null,this),APP.Canvas.off(null,null,this)},randomize:function(){var a=this.get("range");switch(this.get("placement")){case"one":this.set({overlay:{r:_.random(0,255),g:_.random(0,255),b:_.random(0,255),a:Math.random()},angle:this.rnd("angle"),opacity:this.rnd("opacity"),width:this.rnd("width"),height:this.rnd("height"),x:this.rnd("x"),grid:a.grid.values[_.random(0,3)],y:this.rnd("y")});break;case"random":this.change_layout(),this.set({count:this.rnd("count"),overlay:{r:_.random(0,255),g:_.random(0,255),b:_.random(0,255),a:Math.random()},grid:a.grid.values[_.random(0,1)],opacity:this.rnd("opacity"),width:this.rnd("width"),height:this.rnd("height")});break;case"circle":this.set({count:this.rnd("count"),overlay:{r:_.random(0,255),g:_.random(0,255),b:_.random(0,255),a:Math.random()},grid:a.grid.values[_.random(0,1)],angle:this.rnd("angle"),opacity:this.rnd("opacity"),angle_delta:this.rnd("angle_delta"),offset:this.rnd("offset"),width:this.rnd("width"),height:this.rnd("height"),x:this.rnd("x"),y:this.rnd("y"),radius:this.rnd("radius")})}},rnd:function(a){var b=this.get("range");return _.random(b[a].min/b[a].step,b[a].max/b[a].step)*b[a].step},updateFilter:function(a){var b=this.get("overlay");this.original_fabric.filters[0].color="rgba("+b.r+", "+b.g+", "+b.b+", "+b.a+")",this.original_fabric.filters[0].opacity=b.a,this.original_fabric.applyFilters(a)},lock_ratio:function(){this.off("change",this.model_changed),this.setRange(),this.updateElementSize(),this.on("change",this.model_changed)},process_ratio:function(a){var b=this.get("width"),c=this.get("height"),d=this.get("ratio");!_.has(a,"width")&&_.has(a,"height")?b=c*d:c=b/d,this.set({width:b,height:c}),this.updateElementSize()},canvasSizeChanged:function(){this.off("change",this.model_changed),this.setRange(),this.updateElementSize(),this.layout(),this.events.trigger("change:canvas"),this.events.trigger("change:grid"),this.on("change",this.model_changed),this.trigger("render")}}),Grid=Backbone.Model.extend({objects:null,model:null,sample_events:null,events:null,info:null,tl:null,br:null,visible_parts:null,fabric_element:null,initialize:function(a,b){this.events=_.extend({},Backbone.Events),this.objects=new Backbone.Collection([],{model:Fabric}),this.sample_events=b.sample_events,this.info={},this.set("visible",!0),this.updateBoundingPoints(),this.calculateGrid(),this.sample_events.on("visible",this.visible,this),this.sample_events.on("change:grid",this.calculateGrid,this),this.sample_events.on("change:layer",this.changeLayer,this),this.sample_events.on("change:fabric_element",this.updateElement,this),this.sample_events.on("change:canvas",this.updateBoundingPoints,this)},changeLayer:function(a){this.set("layer",a)},calculateGrid:function(){var a=this.get("grid"),b=this.get("x"),c=this.get("y"),d=this.get("width"),e=this.get("height"),f=this.get("angle"),g=(this.get("opacity"),this.get("visible")),h=APP.Canvas.getWidth()/Math.sqrt(a),i=APP.Canvas.getHeight()/Math.sqrt(a),j=0,k=1,l=!0,m=new DoubleLinkedList,n=-f/180*Math.PI,o=Math.cos(n),p=Math.sin(n),q=[this.tr.scalarAdd(0),this.br.scalarAdd(0),this.bl.scalarAdd(0),this.tl.scalarAdd(0)],r=[{x:d/2,y:e/2},{x:d/2,y:-e/2}];r=[new fabric.Point(r[0].x*o-r[0].y*p,r[0].x*p+r[0].y*o),new fabric.Point(r[1].x*o-r[1].y*p,r[1].x*p+r[1].y*o)],r[2]=r[0].multiply(-1),r[3]=r[1].multiply(-1),this.info.el={},this.info.cnv={};var s=[[o,-p],[p,o]];for(this.info.M=s,this.info.el.norm=this.getShadows(r),this.rotatePoints(r,s),this.info.el.A=this.getShadows(r),this.info.cnv.norm=this.getShadows(q),this.rotatePoints(q,s),this.info.cnv.A=this.getShadows(q),this.isVisible(b,c)&&m.add({x:b,y:c},0,0);l||!m.length;){for(l=!1,j=-k;k>=j;j++)this.isVisible(b+j*h,c+k*i)&&(l=!0,m.add({x:b+j*h,y:c+k*i},j,k)),this.isVisible(b+j*h,c-k*i)&&(l=!0,m.add({x:b+j*h,y:c-k*i},j,-k));for(j=-k+1;k-1>=j;j++)this.isVisible(b+k*h,c+j*i)&&(l=!0,m.add({x:b+k*h,y:c+j*i},k,j)),this.isVisible(b-k*h,c+j*i)&&(l=!0,m.add({x:b-k*h,y:c+j*i},-k,j));if(k++,k>40||m.length>200)break}j=0;var t=m.toArray();for(this.visible_parts=t.length;this.objects.length<this.visible_parts;)this.objects.add(this.attributes,{sample_events:this.sample_events,grid_events:this.events,el:this.fabric_element});for(;j<this.visible_parts;)this.objects.at(j).set({show:g,x:t[j].x,y:t[j++].y,width:d,height:e,angle:f});for(;j<this.objects.length;)this.objects.at(j++).set({show:!1})},isVisible:function(a,b){var c={x:a,y:b},d={x:a,y:b},e=this.info.el,f=this.info.cnv;this.rotatePoints(d,this.info.M);var g={};if(g.x_max=e.norm.x_max+c.x,g.x_min=e.norm.x_min+c.x,g.y_max=e.norm.y_max+c.y,g.y_min=e.norm.y_min+c.y,this.compareShadows(f.norm,e.norm))return!1;var h={};return h.x_max=e.A.x_max+d.x,h.x_min=e.A.x_min+d.x,h.y_max=e.A.y_max+d.y,h.y_min=e.A.y_min+d.y,!this.compareShadows(f.A,h)},getShadows:function(a){return{x_max:Math.max(a[0].x,a[1].x,a[2].x,a[3].x),x_min:Math.min(a[0].x,a[1].x,a[2].x,a[3].x),y_max:Math.max(a[0].y,a[1].y,a[2].y,a[3].y),y_min:Math.min(a[0].y,a[1].y,a[2].y,a[3].y)}},rotatePoints:function(a,b){var c,d;if(_.isArray(a))for(i=0;i<a.length;i++)c=a[i].x*b[0][0]+a[i].y*b[0][1],d=a[i].x*b[1][0]+a[i].y*b[1][1],a[i].x=c,a[i].y=d;else _.isObject(a)&&(c=a.x*b[0][0]+a.y*b[0][1],d=a.x*b[1][0]+a.y*b[1][1],a.x=c,a.y=d)},compareShadows:function(a,b){return a.x_max<b.x_min||a.x_min>b.x_max||a.y_max<b.y_min||a.y_min>b.y_max},updateBoundingPoints:function(){var a=APP.Canvas.getWidth()/2,b=APP.Canvas.getHeight()/2;this.tl=new fabric.Point(-a,b),this.tr=new fabric.Point(a,b),this.br=new fabric.Point(a,-b),this.bl=new fabric.Point(-a,-b)},updateElement:function(a){this.fabric_element=a},visible:function(a){this.set("visible",a),this.events.trigger("visible",a)}}),Fabric=Backbone.Model.extend({_fabric:null,sample_events:null,defaults:{show:!1},initialize:function(a,b){this._fabric=new fabric.Image(this.get("img"),{visible:this.get("show"),originX:"center",originY:"center"}),b.el&&this.updateFabricElement(b.el),this.sample_events=b.sample_events,this.grid_events=b.grid_events,this.add(),this.on("change",this.updateFabricProperties),this.on("change:show",this.show),this.grid_events.on("visible",this.visible,this),this.sample_events.on("change:fabric_element",this.updateFabricElement,this),this.sample_events.on("change:fabric_element",this.updateFabricElement,this),this.sample_events.on("change:opacity",this.updateOpacity,this),this.sample_events.on("change:canvas",this.updateFabricProperties,this),this.sample_events.on("change:layer",this.changeLayer,this),this.sample_events.on("remove:fabric",function(){this.off(null,null,this),APP.Events.off(null,null,this),this.grid_events.off(null,null,this),this.sample_events.off(null,null,this)},this),APP.Events.on("reinitialize",this.add,this)},add:function(){APP.Canvas.add(this._fabric)},show:function(){this._fabric.set("visible",this.get("show"))},visible:function(a){this.set("show",a)},changeLayer:function(a){this.set("layer",a)},updateFabricElement:function(a){this._fabric._element=a},updateOpacity:function(a){this.set("opacity",a)},updateFabricProperties:function(){this._fabric.set({layer:this.get("layer"),left:APP.Canvas.getCenter().left+this.get("x"),top:APP.Canvas.getCenter().top-this.get("y"),width:this.get("width"),height:this.get("height"),angle:this.get("angle"),opacity:this.get("opacity")})}}),SampleCollection=Backbone.Collection.extend({model:Sample,initialize:function(){this.on("add",this.add_model),this.on("remove",this.remove_model),this.on("render",APP.Canvas.update,APP.Canvas)},add_model:function(a){a.resize_and_filter(_.bind(function(){var b=new SampleView({model:a});a.view=b,b.render().init_controls().place(),APP.Canvas.update(),recalculate_tab_width()},this))},move:function(a,b){var c=this.at(a);this.remove(c,{silent:!0}),this.add(c,{at:b,silent:!0}),this.each(function(a,b){a.set("layer",b)}),APP.Canvas.update()},swap:function(a,b){this.models[a]=this.models.splice(b,1,this.models[a])[0],this.models[a].set("layer",a),this.models[b].set("layer",b),APP.Canvas.update()},remove_model:function(a){APP.Canvas.removeAll(),this.each(function(a,b){a.set("layer",b)}),APP.Events.trigger("reinitialize"),APP.Canvas.update(),a.off()}}),Library=Backbone.Model.extend({initialize:function(a,b){this.items=new Backbone.Collection([],{model:Item}),this.view=new LibraryView({model:this}),this.view.$els=new Array(this.items.length);for(var c=0;c<b.total;c++)this.view.$els[c]=this.items.add({sprite_name:this.get("sprite_name"),bg_url:this.get("sprite_path")+this.get("sprite_name"),offset_x:c%b.width/(b.width-1)*100+"%",offset_y:Math.floor(c/b.width)/(b.height-1)*100+"%",bg_size:100*b.width+"%",number:c+1}).view.render().$el;this.view.render()}}),Item=Backbone.Model.extend({initialize:function(){this.view=new ItemView({model:this})}}),LibraryView=Backbone.View.extend({tagName:"div",className:"tab-pane fade",$els:null,$link:null,initialize:function(){this.model.on("change render",this.render,this),$("#sample-tabs-content").append(this.$el.attr("id",this.model.get("id_name"))),this.$link=$('<li><a href="#'+this.model.get("id_name")+'" tabindex="-1" data-toggle="tab">'+this.model.get("name")+"</a></li>"),this.$link.find("a").on("shown.bs.tab",update_dropdown_caption),$("#sample-collections-tabs").find(".dropdown-menu").append(this.$link)},render:function(){return $.each(this.$els,_.bind(function(a,b){this.$el.append(b)},this)),this}}),ItemView=Backbone.View.extend({tagName:"div",className:"box generated",template:templates.library_item,initialize:function(){this.model.on("change render",this.render,this)},render:function(){return this.$el.html(this.template(_.assign({$i:localeStrings},this.model.attributes))),this},events:{"click a.innerContent":"onclick"},onclick:function(a){select_from_library(a)}}),Libraries=Backbone.Collection.extend({model:Library,initialize:function(){this.on("add",this.add_library),this.add({name:"Sample 1",id_name:"sample_1",sprite_path:"/img/samples/",sprite_name:"sample_1.sprite.png"},{total:100,width:13,height:8,item_width:150,item_height:150}),this.initUI()},initUI:function(){$("#sample-collections-tabs").find(".dropdown-menu a:last").tab("show")}}),APP={Canvas:null,Samples:null,Events:_.extend({},Backbone.Events),LoadingOverlay:$("#loading-hover"),init:function(){console.log("init start"),APP.loading(!0),this.Canvas=new Canvas,this.Samples=new SampleCollection,this.Library=new Libraries,this.initUI(),APP.loading(!1),console.log("init end")},initUI:function(){$(".upload-file").click(upload_file),$("#file-uploader").change(handle_image),$("a.innerContent").click(select_from_library),$("#input-link").change(select_from_internet),$(".add-free-drawing-tab").click(add_drawing_mode_sample),$("#paste-link-button").click(function(){$("#input-link").trigger("submit")}),$("#paste_link_modal").on("hidden.bs.modal",on_modal_paste_link_hide).on("shown.bs.modal",function(){$("#input-link").focus()}),$("button.preview-button").mousedown(hide_controls_and_show_bg).mouseleave(show_controls).mouseup(show_controls),$('a[data-toggle="tab"]').on("shown.bs.tab",update_dropdown_caption),$(".sample-tabs").sortable({items:"> li",axis:"x",containment:"parent",delay:100,sort:function(a,b){var c=$(this),d=b.helper.outerWidth();c.children().each(function(){if($(this).hasClass("ui-sortable-helper")||$(this).hasClass("ui-sortable-placeholder"))return!0;var a=Math.abs(b.position.left-$(this).position().left),e=b.position.left>$(this).position().left;return d-a>d/2&&d>a?(e?$(".ui-sortable-placeholder",c).insertBefore($(this)):$(".ui-sortable-placeholder",c).insertAfter($(this)),!1):void 0})},start:function(a,b){$(this).attr("data-previndex",b.item.index())},stop:function(a,b){var c=b.item.index(),d=parseInt($(this).attr("data-previndex"));$(this).removeAttr("data-previndex"),d!=c&&APP.Samples.move(d,c)},distance:2,revert:100,scroll:!1}),$(window).resize(this.onResize).resize()},loading:function(a){a?this.LoadingOverlay.removeClass("non-visible"):this.LoadingOverlay.addClass("non-visible")},addSample:function(){APP.loading(!0),APP.loading(!1)},alert:function(a){a=a||"Sorry, something is going wrong :C<br>Our team working on this problem!";var b=$('<div class="auto-hidden-alert new">'+a+"</div>");$(".alerts").append(b);var c=_.bind(function(){$(this).clearQueue().addClass("deleted").delay(1100).slideUp(450).queue(function(a){$(this).remove(),a()})},b);b.click(c),setTimeout(c,5e3)},onResize:_.debounce(function(){recalculate_tab_width(),dropdown_add_align()},100)};$(function(){APP.init()});